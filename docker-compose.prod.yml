version: '3.8'

services:
  # --- Ton Application Spring Boot ---
  backend-app:
    build: .  # Construit l'image à partir du Dockerfile courant
    container_name: spring-app-prod
    restart: always  # Redémarre automatiquement si l'app crashe ou si le serveur reboot
    # Charge les variables depuis le fichier .env qui sera sur le serveur
    env_file:
      - .env
    environment:
      # On peut surcharger certaines variables spécifiques à docker ici si besoin
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/production_db
      - SPRING_REDIS_HOST=redis-cache
      - MINIO_URL=http://minio-storage:9000
    depends_on:
      - mysql-db
      - redis-cache
      - minio-storage
    networks:
      - app-network

  # --- Base de données MySQL ---
  mysql-db:
    image: mysql:8.0
    container_name: mysql-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: mon_super_mot_de_passe_mysql
      MYSQL_DATABASE: production_db
    volumes:
      - ./mysql_data:/var/lib/mysql # Persistance des données sur la VM
    networks:
      - app-network

  # --- Cache Redis ---
  redis-cache:
    image: redis:alpine
    container_name: redis-prod
    restart: always
    networks:
      - app-network

  # --- Stockage MinIO ---
  minio-storage:
    image: minio/minio
    container_name: minio-prod
    restart: always
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" # API S3
      - "9001:9001" # Console Web MinIO
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - ./minio_data:/data # Persistance des fichiers sur la VM
    networks:
      - app-network

networks:
  app-network:
    driver: bridge